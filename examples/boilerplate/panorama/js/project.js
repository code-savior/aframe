var project = {
    "bg_h5startup_option": 0,
    "bg_music_loop": true,
    "bg_music_mute": false,
    "bg_music_volume": 100,
    "bg_picture_option": 0,
    "description": "",
    "embeds": [
        {
            "embed_media": {
                "uuid": "133c153a7f19445c9556624fb6cad54d"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 5,
            "end_time": 3600,
            "link_icon": "mp4",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": -7.377392292022705,
            "pos_yaw": 93.10122680664062,
            "resized_embed_media_height": 312,
            "resized_embed_media_path": "resized/embed/1a0d90dd4c104859905d5b180e1fb1bd/75a5c5c326504b52a68df86db06796cd.jpg",
            "resized_embed_media_width": 468,
            "source_stage": {
                "uuid": "322e152f6b0f4a348330fc0ba9b6d469"
            },
            "spin_polar_pitch": 6.599999904632568,
            "spin_polar_roll": 0.30000001192092896,
            "spin_polar_yaw": 17.35402488708496,
            "start_time": 0,
            "title": "直播",
            "title_visible": false,
            "uuid": "1a0d90dd4c104859905d5b180e1fb1bd",
            "visible": true,
            "zoom_scale": 156
        },
        {
            "embed_media": {
                "uuid": "75a5c5c326504b52a68df86db06796cd"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 1,
            "end_time": 3600,
            "link_icon": "img2",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": -50.6346549987793,
            "pos_yaw": 142.374267578125,
            "resized_embed_media_height": 422,
            "resized_embed_media_path": "resize-1.jpg",
            "resized_embed_media_width": 632,
            "source_stage": {
                "uuid": "6bec0a0ed3f740f18631790310b3a952"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "title": "p.jpg",
            "title_visible": false,
            "uuid": "45f15f63f5a74ec1b777f4e5c3bd8e1e",
            "visible": true,
            "zoom_scale": 211
        },
        {
            "embed_media": {
                "uuid": "75a5c5c326504b52a68df86db06796cd"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 1,
            "end_time": 3600,
            "link_icon": "img2",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": -74.64857482910156,
            "pos_yaw": 142.10189819335938,
            "resized_embed_media_height": 422,
            "resized_embed_media_path": "resize-2.jpg",
            "resized_embed_media_width": 632,
            "source_stage": {
                "uuid": "6bec0a0ed3f740f18631790310b3a952"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "title": "p.jpg",
            "title_visible": false,
            "uuid": "2ed3ee86412b4b66a68ab398e077976b",
            "visible": true,
            "zoom_scale": 211
        },
        {
            "embed_media": {
                "uuid": "867b2855e8a14357b44d739ccc9cde44"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 0,
            "end_time": 3600,
            "link_icon": "video1",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": 0.004404752049595118,
            "pos_yaw": 170.05860900878906,
            "resized_embed_media_height": 230,
            "resized_embed_media_path": "resized/embed/90d90ff3dd0c4ea89b31e3ebda7d74dc/867b2855e8a14357b44d739ccc9cde44.mp4",
            "resized_embed_media_width": 460,
            "source_stage": {
                "uuid": "322e152f6b0f4a348330fc0ba9b6d469"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 21.447736740112305,
            "start_time": 0,
            "title": "v1.mp4",
            "title_visible": false,
            "uuid": "90d90ff3dd0c4ea89b31e3ebda7d74dc",
            "visible": true,
            "zoom_scale": 23
        }
    ],
    "encode_param.bitrate": 10000,
    "encode_param.bitrate_mode": 0,
    "encode_param.resolution": "3840*1920",
    "encode_param.resolution_mode": 0,
    "hotspots": [
        {
            "end_time": 3600,
            "link_icon": "click_touch",
            "opacity": 100,
            "pos_pitch": 3.4,
            "pos_yaw": -30.7,
            "source_stage": {
                "uuid": "6bec0a0ed3f740f18631790310b3a952"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "target_stage": {
                "uuid": "322e152f6b0f4a348330fc0ba9b6d469"
            },
            // "title": "<div style=\" padding: 5px;background-color: rgba(0, 0, 0, 0.3);border-radius: 4px;font-family: Microsoft YaHei;font-size: 28px;color: #ffffff; \">room.jpg</div>",
            "title": "room",
            "title_visible": true,
            "uuid": "d9c88162b5fd4720af5bca77857a8146",
            "visible": true,
            "zoom_scale": 100
        },
        {
            "end_time": 3600,
            "link_icon": "click_touch",
            "opacity": 100,
            "pos_pitch": 6.711202621459961,
            "pos_yaw": 92.78353881835938,
            "source_stage": {
                "uuid": "322e152f6b0f4a348330fc0ba9b6d469"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "target_stage": {
                "uuid": "6bec0a0ed3f740f18631790310b3a952"
            },
            // "title": "<div style=\" padding: 5px;background-color: rgba(0, 0, 0, 0.3);border-radius: 4px;font-family: Microsoft YaHei;font-size: 28px;color: #ffffff; \">angra.jpg</div>",
            "title": "out",
            "title_visible": true,
            "uuid": "4a4a3f98089d42468faa4a94aab9ad35",
            "visible": true,
            "zoom_scale": 100
        }
    ],
    "mediabox": {
        "mediaboxes": [
        ],
        "medias": [
            {
                "uuid": "8fd3465947f24b489dbea1e1fb5e756c"
            },
            {
                "uuid": "75a5c5c326504b52a68df86db06796cd"
            },
            {
                "uuid": "448ffc4461f7401888d2632f80df1aaa"
            },
            {
                "uuid": "133c153a7f19445c9556624fb6cad54d"
            },
            {
                "uuid": "867b2855e8a14357b44d739ccc9cde44"
            }
        ],
        "title": "全部"
    },
    "medias": [
        {
            "audio_bitrate": 0,
            "audio_codec": "",
            "duration": 0,
            "file_hash": "",
            "file_size": "2430051",
            "frame_rate": 0,
            "height": 2000,
            "is_cache": false,
            "orig_filename": "p1.jpg",
            "path": "p1.jpg",
            "projection_angle": 360,
            "title": "",
            "type": "Photo",
            "uuid": "8fd3465947f24b489dbea1e1fb5e756c",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 1,
            "width": 4000
        },
        {
            "audio_bitrate": 0,
            "audio_codec": "",
            "duration": 0,
            "file_hash": "",
            "file_size": "758029",
            "frame_rate": 0,
            "height": 1920,
            "is_cache": false,
            "orig_filename": "room.jpg",
            "path": "room.jpg",
            "projection_angle": 360,
            "title": "",
            "type": "Photo",
            "uuid": "448ffc4461f7401888d2632f80df1aaa",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 1,
            "width": 3840
        },
        {
            "audio_bitrate": 0,
            "audio_codec": "aac",
            "duration": 0,
            "file_hash": "",
            "file_size": "0",
            "frame_rate": 30,
            "height": 0,
            "is_cache": false,
            "live_end_time": "2022-01-15 21:15:24",
            "live_start_time": "2022-01-14 21:15:24",
            "orig_filename": "index.m3u8",
            "path": "https://cctvalih5ca.v.myalicdn.com/live/cctv1_2/index.m3u8",
            "projection_angle": 360,
            "shot_media": {
                "uuid": "75a5c5c326504b52a68df86db06796cd"
            },
            "title": "直播",
            "type": "Live",
            "uuid": "133c153a7f19445c9556624fb6cad54d",
            "video_bitrate": 0,
            "video_codec": "h264",
            "vr_tag": 0,
            "width": 0
        },
        {
            "audio_bitrate": 0,
            "audio_codec": "",
            "duration": 0,
            "file_hash": "",
            "file_size": "26974",
            "frame_rate": 0,
            "height": 200,
            "is_cache": false,
            "orig_filename": "p.jpg",
            "path": "e1.jpg",
            "projection_angle": 360,
            "title": "",
            "type": "Photo",
            "uuid": "75a5c5c326504b52a68df86db06796cd",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 0,
            "width": 300
        },
        {
            "audio_bitrate": 317375,
            "audio_codec": "aac",
            "duration": 29.766666412353516,
            "file_hash": "",
            "file_size": "44349115",
            "frame_rate": 30,
            "height": 1920,
            "is_cache": false,
            "orig_filename": "v1.mp4",
            "path": "v1.mp4",
            "projection_angle": 360,
            "title": "",
            "type": "Video",
            "uuid": "867b2855e8a14357b44d739ccc9cde44",
            "video_bitrate": 11594086,
            "video_codec": "h264",
            "vr_tag": 1,
            "width": 3840
        }
    ],
    "origin_uuid": "3047de572b4c4df68f22b82da54df0e9",
    "stages": [
        {
            "end_time": 3600,
            "end_time_visible": false,
            "fov_current": 90,
            "fov_global": true,
            "fov_max": 110,
            "fov_min": 60,
            "isStart": true,
            "mask_enable": true,
            "mask_follow_rotate": true,
            "mask_zoom_scale": 100,
            "media": {
                "uuid": "8fd3465947f24b489dbea1e1fb5e756c"
            },
            "play_action": 0,
            "play_delay_deconds": 0,
            "play_jump_stage": {
                "uuid": "322e152f6b0f4a348330fc0ba9b6d469"
            },
            "primary_pitch": 0,
            "primary_roll": 0,
            "primary_yaw": 0,
            "scene_pos_x": -379,
            "scene_pos_y": -20,
            "start_pitch": 0,
            "start_time": 0,
            "start_time_visible": false,
            "start_yaw": 0,
            "uuid": "6bec0a0ed3f740f18631790310b3a952",
            "view_mode": 0
        },
        {
            "end_time": 3600,
            "end_time_visible": false,
            "fov_current": 90,
            "fov_global": true,
            "fov_max": 110,
            "fov_min": 60,
            "isStart": false,
            "mask_enable": true,
            "mask_follow_rotate": true,
            "mask_zoom_scale": 100,
            "media": {
                "uuid": "448ffc4461f7401888d2632f80df1aaa"
            },
            "play_action": 0,
            "play_delay_deconds": 0,
            "play_jump_stage": {
                "uuid": "6bec0a0ed3f740f18631790310b3a952"
            },
            "primary_pitch": 0,
            "primary_roll": 0,
            "primary_yaw": 0,
            "scene_pos_x": -156,
            "scene_pos_y": -22,
            "start_pitch": 0,
            "start_time": 0,
            "start_time_visible": false,
            "start_yaw": 0,
            "uuid": "322e152f6b0f4a348330fc0ba9b6d469",
            "view_mode": 0
        }
    ],
    "title": "v1.3",
    "uuid": "d6c630ad106d4706a09b495749b7ba08",
    "version": "1.2"
};

function getSceneFromProject(sceneid) {
    const media = getSceneMedia(sceneid);
    const hotspots = getSceneHotspots(sceneid);
    const photoEmbeds = getScenePhotoEmbeds(sceneid);
    const videoEmbeds = getSceneVideoEmbeds(sceneid);

    return {
        type: media.type,
        media: media.path,
        hotspots,
        photoEmbeds,
        videoEmbeds,
    };
}

function getSceneHotspots(sceneid) {
    const hotspots = project.hotspots.filter(function(hotspot) {
        return hotspot.source_stage.uuid === sceneid && hotspot.visible === true
    });

    return hotspots.map(function(hotspot){
        const positon = convertPosition({pos_yaw: hotspot.pos_yaw, pos_pitch: hotspot.pos_pitch});
        return {
            icon: `assets/icon/hotspot/${hotspot.link_icon}.png`,
            title: hotspot.title,
            sceneid: hotspot.target_stage.uuid,
            pos_yaw: positon.yaw,
            pos_pitch: positon.pitch,
        }
    });
}

function convertPosition(position){
    return {
        yaw: THREE.Math.degToRad(180 - position.pos_yaw),
        pitch: THREE.Math.degToRad(90 - position.pos_pitch),
    };
}

function getScenePhotoEmbeds(sceneid) {
    const embeds = project.embeds.filter(function(embed) {
        return embed.source_stage.uuid === sceneid && embed.embed_type === 1 && embed.visible === true
    });

    return embeds.map(function(embed){
        const media = getPhotoEmbedMedia(embed);
        const positon = convertPosition({pos_yaw: embed.pos_yaw, pos_pitch: embed.pos_pitch});
        return {
            media: media.media,
            width: media.width,
            height: media.height,
            pos_yaw: positon.yaw,
            pos_pitch: positon.pitch,
        }
    });
}

function getPhotoEmbedMedia(embed){
    if(embed.resized_embed_media_path){
        return {
            media: `medias/${embed.resized_embed_media_path}`,
            width: embed.resized_embed_media_width,
            height: embed.resized_embed_media_height,
        };
    }else{
        const media = getMedia(embed.embed_media.uuid);
        return {
            media: `medias/${media.path}`,
            width: media.width,
            height: media.height,
        };
    }
}

function getSceneVideoEmbeds(sceneid) {
    const embeds = project.embeds.filter(function(embed) {
        return embed.source_stage.uuid === sceneid && embed.embed_type === 0 && embed.visible === true
    });

    return embeds.map(function(embed){
        const media = getMedia(embed.embed_media.uuid);
        return {
            media: `medias/${media.path}`,
        }
    });
}

function getSceneMedia(sceneid) {
    const scene = project.stages.filter(function(stage) {
        return stage.uuid === sceneid
    })[0];
    const media = getMedia(scene.media.uuid);
    let type;
    switch (media.type) {
        case 'Photo':
            type = 'photo';
            break;
        case 'Video':
            type = 'video';
            break;
    };
    const path = `medias/${media.path}`;
    return {
        type,
        path,
    };
}

function getMedia(mediaid) {
    const media = project.medias.filter(function(media) {
        return media.uuid === mediaid
    })[0];
    return media;
}

function getFirstSceneid() {
    return project.stages.filter(function(stage) {
        return stage.isStart
    })[0].uuid
}