var project = {
    "bg_h5startup_option": 0,
    "bg_music_loop": true,
    "bg_music_mute": false,
    "bg_music_volume": 100,
    "bg_picture_option": 0,
    "description": "",
    "embeds": [
        {
            "embed_media": {
                "uuid": "ba3357a39fad44b6bc1e0f6986e346e9"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 1,
            "end_time": 3600,
            "link_icon": "img2",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": -46.99285888671875,
            "pos_yaw": 144.95474243164062,
            "resized_embed_media_height": 200,
            "resized_embed_media_width": 300,
            "source_stage": {
                "uuid": "27b2e5e956c24ca797a53ac25a8b4745"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "title": "p.jpg",
            "title_visible": false,
            "uuid": "ba4778140ffc4305bc354c385c11e83b",
            "visible": true,
            "zoom_scale": 100
        },
        {
            "embed_media": {
                "uuid": "f175180f0b6640028be3286901a5ae59"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 0,
            "end_time": 3600,
            "link_icon": "video1",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": 30.372314453125,
            "pos_yaw": 130.39064025878906,
            "resized_embed_media_height": 550,
            "resized_embed_media_path": "v1.mp4",
            "resized_embed_media_width": 1100,
            "source_stage": {
                "uuid": "27b2e5e956c24ca797a53ac25a8b4745"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "title": "vr.mp4",
            "title_visible": false,
            "uuid": "798e8a1afacc4167847029701edf5d8c",
            "visible": true,
            "zoom_scale": 55
        },
        {
            "embed_media": {
                "uuid": "7cccc84a0ba140ce805144b8009e6ec7"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 5,
            "end_time": 3600,
            "link_icon": "mp4",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": -7.417114734649658,
            "pos_yaw": 93.25372314453125,
            "resized_embed_media_height": 300,
            "resized_embed_media_path": "resized/embed/893ea60670e74edfa9c1051eb91fc644/ba3357a39fad44b6bc1e0f6986e346e9.jpg",
            "resized_embed_media_width": 450,
            "source_stage": {
                "uuid": "5ba494a4f74940feb18a83ad70a46679"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 1.7000000476837158,
            "spin_polar_yaw": 18.434947967529297,
            "start_time": 0,
            "title": "live",
            "title_visible": false,
            "uuid": "893ea60670e74edfa9c1051eb91fc644",
            "visible": true,
            "zoom_scale": 150
        },
        {
            "audio_mute": false,
            "audio_volume": 100,
            "embed_media": {
                "uuid": "c07622e618064a78aade35f55f1a5828"
            },
            "embed_mode": 0,
            "embed_play_control": true,
            "embed_text": "",
            "embed_type": 3,
            "end_time": 3600,
            "link_icon": "mp4",
            "opacity": 100,
            "play_loop": true,
            "pos_pitch": 4.573389530181885,
            "pos_yaw": -79.4117660522461,
            "resized_embed_media_height": 0,
            "resized_embed_media_width": 0,
            "source_stage": {
                "uuid": "5ba494a4f74940feb18a83ad70a46679"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "title": "sj",
            "title_visible": false,
            "uuid": "7efb586fe6c944839f1b8a225f928ac1",
            "visible": true,
            "zoom_scale": 100
        }
    ],
    "encode_param.bitrate": 10000,
    "encode_param.bitrate_mode": 0,
    "encode_param.resolution": "3840*1920",
    "encode_param.resolution_mode": 0,
    "hotspots": [
        {
            "end_time": 3600,
            "link_icon": "click_touch",
            "opacity": 100,
            "pos_pitch": 3.347917079925537,
            "pos_yaw": -30.13576316833496,
            "source_stage": {
                "uuid": "27b2e5e956c24ca797a53ac25a8b4745"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "target_stage": {
                "uuid": "5ba494a4f74940feb18a83ad70a46679"
            },
            // "title": "<div style=\" padding: 5px;background-color: rgba(0, 0, 0, 0.3);border-radius: 4px;font-family: Microsoft YaHei;font-size: 28px;color: #ffffff; \">room</div>",
            "title": "room",
            "title_visible": true,
            "uuid": "283e2729b3fe4ef997ce66e18933a6f8",
            "visible": true,
            "zoom_scale": 100
        },
        {
            "end_time": 3600,
            "link_icon": "spotd4.gif",
            "opacity": 100,
            "pos_pitch": -1.851332187652588,
            "pos_yaw": -135.80224609375,
            "source_stage": {
                "uuid": "5ba494a4f74940feb18a83ad70a46679"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "target_stage": {
                "uuid": "27b2e5e956c24ca797a53ac25a8b4745"
            },
            // "title": "<div style=\" padding: 5px;background-color: rgba(0, 0, 0, 0.3);border-radius: 4px;font-family: Microsoft YaHei;font-size: 28px;color: #ffffff; \">out</div>",
            "title": "out",
            "title_visible": true,
            "uuid": "5006d190b41444a684052a44a4f9709b",
            "visible": true,
            "zoom_scale": 100
        },
        {
            "end_time": 3600,
            "link_icon": "spotd1.gif",
            "opacity": 100,
            "pos_pitch": 5.699999809265137,
            "pos_yaw": 92.5,
            "source_stage": {
                "uuid": "5ba494a4f74940feb18a83ad70a46679"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "target_stage": {
                "uuid": "b5121b24f07d4fffbeb693f86a38a099"
            },
            // "title": "<div style=\" padding: 5px;background-color: rgba(0, 0, 0, 0.3);border-radius: 4px;font-family: Microsoft YaHei;font-size: 28px;color: #ffffff; \">live</div>",
            "title": "live",
            "title_visible": true,
            "uuid": "4a77718e441d42cc997662df46984542",
            "visible": true,
            "zoom_scale": 100
        },
        {
            "end_time": 3600,
            "link_icon": "click_touch",
            "opacity": 100,
            "pos_pitch": 0,
            "pos_yaw": 0,
            "source_stage": {
                "uuid": "b5121b24f07d4fffbeb693f86a38a099"
            },
            "spin_polar_pitch": 0,
            "spin_polar_roll": 0,
            "spin_polar_yaw": 0,
            "start_time": 0,
            "target_stage": {
                "uuid": "5ba494a4f74940feb18a83ad70a46679"
            },
            "title": "<div style=\" padding: 5px;background-color: rgba(0, 0, 0, 0.3);border-radius: 4px;font-family: Microsoft YaHei;font-size: 28px;color: #ffffff; \">room.jpg</div>",
            "title_visible": true,
            "uuid": "ebb5314e9e9245d6b38dfbe0545b4d32",
            "visible": true,
            "zoom_scale": 100
        }
    ],
    "mediabox": {
        "mediaboxes": [
        ],
        "medias": [
            {
                "uuid": "f175180f0b6640028be3286901a5ae59"
            },
            {
                "uuid": "ee3f7eef16ad4775842f7e47650b890f"
            },
            {
                "uuid": "ba3357a39fad44b6bc1e0f6986e346e9"
            },
            {
                "uuid": "beb60f85f33b484685f8ac20bf1c1166"
            },
            {
                "uuid": "7cccc84a0ba140ce805144b8009e6ec7"
            },
            {
                "uuid": "c07622e618064a78aade35f55f1a5828"
            }
        ],
        "title": "全部"
    },
    "medias": [
        {
            "audio_bitrate": 0,
            "audio_codec": "",
            "duration": 0,
            "file_hash": "",
            "file_size": "2430051",
            "frame_rate": 0,
            "height": 2000,
            "is_cache": false,
            "orig_filename": "angra.jpg",
            "path": "p1.jpg",
            "projection_angle": 360,
            "title": "",
            "type": "Photo",
            "uuid": "ee3f7eef16ad4775842f7e47650b890f",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 1,
            "width": 4000
        },
        {
            "audio_bitrate": 0,
            "audio_codec": "",
            "duration": 0,
            "file_hash": "",
            "file_size": "758029",
            "frame_rate": 0,
            "height": 1920,
            "is_cache": false,
            "orig_filename": "room.jpg",
            "path": "room.jpg",
            "projection_angle": 360,
            "title": "",
            "type": "Photo",
            "uuid": "beb60f85f33b484685f8ac20bf1c1166",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 1,
            "width": 3840
        },
        {
            "audio_bitrate": 0,
            "audio_codec": "",
            "duration": 0,
            "file_hash": "",
            "file_size": "0",
            "frame_rate": 30,
            "height": 0,
            "is_cache": false,
            "live_end_time": "2022-02-19 15:39:42",
            "live_start_time": "2022-01-18 14:39:42",
            "orig_filename": "index.m3u8",
            "path": "https://cctvalih5ca.v.myalicdn.com/live/cctv1_2/index.m3u8",
            "projection_angle": 360,
            "shot_media": {
                "uuid": "ba3357a39fad44b6bc1e0f6986e346e9"
            },
            "title": "直播",
            "type": "Live",
            "uuid": "7cccc84a0ba140ce805144b8009e6ec7",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 1,
            "width": 0
        },
        {
            "audio_bitrate": 0,
            "audio_codec": "",
            "duration": 0,
            "file_hash": "",
            "file_size": "26974",
            "frame_rate": 0,
            "height": 200,
            "is_cache": false,
            "orig_filename": "p.jpg",
            "path": "e1.jpg",
            "projection_angle": 360,
            "title": "",
            "type": "Photo",
            "uuid": "ba3357a39fad44b6bc1e0f6986e346e9",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 0,
            "width": 300
        },
        {
            "audio_bitrate": 317375,
            "audio_codec": "aac",
            "duration": 29.766666412353516,
            "file_hash": "",
            "file_size": "44349115",
            "frame_rate": 30,
            "height": 1920,
            "is_cache": false,
            "orig_filename": "vr.mp4",
            "path": "f175180f0b6640028be3286901a5ae59.mp4",
            "projection_angle": 360,
            "title": "",
            "type": "Video",
            "uuid": "f175180f0b6640028be3286901a5ae59",
            "video_bitrate": 11594086,
            "video_codec": "h264",
            "vr_tag": 1,
            "width": 3840
        },
        {
            "audio_bitrate": 320000,
            "audio_codec": "mp3",
            "duration": 291.03020408163263,
            "file_hash": "",
            "file_size": "11642353",
            "frame_rate": 30,
            "height": 0,
            "is_cache": false,
            "orig_filename": "sj.mp3",
            "path": "sj.mp3",
            "projection_angle": 360,
            "title": "",
            "type": "Audio",
            "uuid": "c07622e618064a78aade35f55f1a5828",
            "video_bitrate": 0,
            "video_codec": "",
            "vr_tag": 0,
            "width": 0
        }
    ],
    "origin_uuid": "07adadc602ca4d91839b9ede00e0e053",
    "stages": [
        {
            "end_time": 3600,
            "end_time_visible": false,
            "fov_current": 90,
            "fov_global": true,
            "fov_max": 110,
            "fov_min": 60,
            "isStart": true,
            "mask_enable": true,
            "mask_follow_rotate": true,
            "mask_zoom_scale": 100,
            "media": {
                "uuid": "ee3f7eef16ad4775842f7e47650b890f"
            },
            "play_action": 0,
            "play_delay_deconds": 0,
            "play_jump_stage": {
                "uuid": "5ba494a4f74940feb18a83ad70a46679"
            },
            "primary_pitch": 0,
            "primary_roll": 0,
            "primary_yaw": 0,
            "scene_pos_x": -403,
            "scene_pos_y": -9,
            "start_pitch": 0,
            "start_time": 0,
            "start_time_visible": false,
            "start_yaw": 0,
            "uuid": "27b2e5e956c24ca797a53ac25a8b4745",
            "view_mode": 0
        },
        {
            "end_time": 3600,
            "end_time_visible": false,
            "fov_current": 90,
            "fov_global": true,
            "fov_max": 110,
            "fov_min": 60,
            "isStart": false,
            "mask_enable": true,
            "mask_follow_rotate": true,
            "mask_zoom_scale": 100,
            "media": {
                "uuid": "beb60f85f33b484685f8ac20bf1c1166"
            },
            "play_action": 0,
            "play_delay_deconds": 0,
            "primary_pitch": 0,
            "primary_roll": 0,
            "primary_yaw": 0,
            "scene_pos_x": -158,
            "scene_pos_y": -14,
            "start_pitch": 0,
            "start_time": 0,
            "start_time_visible": false,
            "start_yaw": 0,
            "uuid": "5ba494a4f74940feb18a83ad70a46679",
            "view_mode": 0
        },
        {
            "end_time": 3600,
            "end_time_visible": false,
            "fov_current": 90,
            "fov_global": true,
            "fov_max": 110,
            "fov_min": 60,
            "isStart": false,
            "mask_enable": true,
            "mask_follow_rotate": true,
            "mask_zoom_scale": 100,
            "media": {
                "uuid": "7cccc84a0ba140ce805144b8009e6ec7"
            },
            "play_action": 0,
            "play_delay_deconds": 0,
            "primary_pitch": 0,
            "primary_roll": 0,
            "primary_yaw": 0,
            "scene_pos_x": 119,
            "scene_pos_y": -16,
            "start_pitch": 0,
            "start_time": 0,
            "start_time_visible": false,
            "start_yaw": 0,
            "uuid": "b5121b24f07d4fffbeb693f86a38a099",
            "view_mode": 0
        }
    ],
    "title": "v1.3",
    "uuid": "becd7ec568ba4caaa94f0193097690b3",
    "version": "1.2"
};

function getSceneFromProject(sceneid) {
    const media = getSceneMedia(sceneid);
    const hotspots = getSceneHotspots(sceneid);
    const photoEmbeds = getScenePhotoEmbeds(sceneid);
    const videoEmbeds = getSceneVideoEmbeds(sceneid);
    const audioEmbeds = getSceneAudioEmbeds(sceneid);

    return {
        type: media.type,
        media: media.path,
        hotspots,
        photoEmbeds,
        videoEmbeds,
        audioEmbeds,
    };
}

function getSceneHotspots(sceneid) {
    const hotspots = project.hotspots.filter(function(hotspot) {
        return hotspot.source_stage.uuid === sceneid && hotspot.visible === true
    });

    return hotspots.map(function(hotspot){
        const position = convertPosition({yaw: hotspot.pos_yaw, pitch: hotspot.pos_pitch});
        return {
            icon: `assets/icon/hotspot/${hotspot.link_icon}${hotspot.link_icon.indexOf('.gif') > -1 ? '' : '.png' }`,
            title: hotspot.title,
            sceneid: hotspot.target_stage.uuid,
            position: position,
        }
    });
}

function convertPosition(position){
    return {
        yaw: THREE.Math.degToRad(180 - position.yaw),
        pitch: THREE.Math.degToRad(90 - position.pitch),
    };
}

function convertRotation(rotation){
    return {
        yaw: THREE.Math.degToRad(rotation.yaw),
        pitch: THREE.Math.degToRad(rotation.pitch),
        roll: THREE.Math.degToRad(rotation.roll),
    };
}

function getScenePhotoEmbeds(sceneid) {
    const embeds = project.embeds.filter(function(embed) {
        return embed.source_stage.uuid === sceneid && embed.embed_type === 1 && embed.visible === true
    });

    return convertEmbed(embeds);
}

function convertEmbed(embeds){
    return embeds.map(function(embed){
        const media = getEmbedMedia(embed);
        const position = convertPosition({yaw: embed.pos_yaw, pitch: embed.pos_pitch});
        const rotation = convertRotation({yaw: embed.spin_polar_yaw, pitch: embed.spin_polar_pitch, roll: embed.spin_polar_roll});
        return {
            media: media.media,
            width: media.width,
            height: media.height,
            position: position,
            rotation: rotation,
        }
    });
}

function getEmbedMedia(embed){
    if(embed.resized_embed_media_path){
        return {
            media: `medias/${embed.resized_embed_media_path}`,
            width: embed.resized_embed_media_width,
            height: embed.resized_embed_media_height,
        };
    }else{
        const media = getMedia(embed.embed_media.uuid);
        return {
            media: `medias/${media.path}`,
            width: media.width,
            height: media.height,
        };
    }
}

function getSceneVideoEmbeds(sceneid) {
    const embeds = project.embeds.filter(function(embed) {
        return embed.source_stage.uuid === sceneid && embed.embed_type === 0 && embed.visible === true
    });
    return convertEmbed(embeds);
}

function getSceneAudioEmbeds(sceneid) {
    const embeds = project.embeds.filter(function(embed) {
        return embed.source_stage.uuid === sceneid && embed.embed_type === 3 && embed.visible === true
    });

    return embeds.map(function(embed){
        const position = convertPosition({yaw: embed.pos_yaw, pitch: embed.pos_pitch});
        const media = getMedia(embed.embed_media.uuid);
        return {
            media: `medias/${media.path}`,
            volume: embed.audio_volume/100,
            loop: embed.play_loop,
            position: position,
        }
    });
}

function getSceneMedia(sceneid) {
    const scene = project.stages.filter(function(stage) {
        return stage.uuid === sceneid
    })[0];
    const media = getMedia(scene.media.uuid);
    let type;
    switch (media.type) {
        case 'Photo':
            type = 'photo';
            break;
        case 'Video':
            type = 'video';
            break;
    };
    const path = `medias/${media.path}`;
    return {
        type,
        path,
    };
}

function getMedia(mediaid) {
    const media = project.medias.filter(function(media) {
        return media.uuid === mediaid
    })[0];
    return media;
}

function getFirstSceneid() {
    return project.stages.filter(function(stage) {
        return stage.isStart
    })[0].uuid
}